# Bug Report: League & Tournament Registration Workflow Fixes (Phase 4)

## Overview

This document summarizes critical bugs identified and resolved during Phase 4 of the Militia Gaming League platform development, specifically related to payment processing, registration, and change request workflows for leagues and tournaments.

---

## 1. Reference ID Length Bug (`reference_id` exceeding 40 characters)

### Issue

- The `reference_id` sent to Square's payment API was generated by concatenating multiple UUIDs and strings.
- This sometimes **exceeded Square's 40-character limit** for the `reference_id` field.
- Resulted in **payment failures** or **rejected API requests**.

### Error Symptoms

- Square API errors indicating invalid or too-long `reference_id`.
- Payments not processed or recorded.

### Resolution

- Updated the reference ID generation logic to:
  - Use a **shorter, deterministic format**.
  - Truncate or hash parts of the ID to ensure **max 40 characters**.
  - Example: `"itemId-shortcode-requestId"` with enforced length limits.
- Added validation to **test reference IDs** before sending to Square.

---

## 2. Season Data Missing (`season` null during record creation)

### Issue

- The `season` number was **not consistently included** in payment metadata or change request data.
- This caused **null values** in the database, leading to:
  - Incomplete records.
  - Errors in downstream processing relying on `season`.

### Error Symptoms

- Change requests or registrations missing `season`.
- Backend errors or incorrect league/tournament data.

### Resolution

- Standardized metadata to **always include a `season` field**:
  - For **league registrations**, the actual season number.
  - For **tournament registrations**, a **default of `0`** (since tournaments don't have seasons).
- Updated both frontend payment details and backend processing to expect and handle this consistently.

---

## 3. Team Change Request Player ID Formatting

### Issue

- The `team_change_requests` table originally had a `player_id` column of type `uuid`.
- Some change requests involved **multiple players**, requiring an **array of UUIDs**.
- The code passed a single UUID or `undefined`, causing:
  - Validation failures.
  - Errors inserting change requests.
  - Loss of player-specific context.

### Error Symptoms

- Console errors: `Invalid player ID format: undefined`
- Failed inserts into `team_change_requests`.
- Incomplete or missing change request records.

### Resolution

- **Database Migration:**
  - Altered `player_id` column to `uuid[]` (array of UUIDs).
  - Dropped incompatible foreign key constraints.
- **Code Updates:**
  - `createTeamChangeRequest` now accepts **single or multiple player IDs**.
  - Validates **each UUID** in the array.
  - Inserts the **array** into the database.
  - Defaults to team captain ID if no players specified (e.g., for league registration).
- **Result:** Supports multi-player change requests without validation errors.

---

## 4. Incorrect Item ID Used in Payments and Change Requests

### Issue

- The `items` table contains:
  - `id` (UUID)
  - `item_id` (4-digit string, e.g., `'1003'`)
- The frontend **mistakenly used the UUID `id`** as the item identifier.
- The backend and payment logic **expected the 4-digit `item_id`**.
- This mismatch caused:
  - Item ID validation failures.
  - Fallbacks to default item IDs (`'1000'`).
  - Potential misclassification of payments and requests.

### Error Symptoms

- Console logs: `Item ID not in correct format, attempting to fix: <UUID>`
- Change requests defaulting to `'1000'`.
- Incorrect or generic item categorization.

### Resolution

- Updated the frontend to:
  - Fetch **both** `id` and `item_id`.
  - **Store and use the 4-digit `item_id`** in all payment details and metadata.
- Ensured all references to item IDs in payment and change request flows use the **correct 4-digit code**.

---

## Summary

| Bug                   | Cause                                       | Fix                                                          |
| --------------------- | ------------------------------------------- | ------------------------------------------------------------ |
| Reference ID too long | Concatenated UUIDs exceeded 40 chars        | Shortened/truncated reference ID, enforced length            |
| Season data missing   | Metadata inconsistent                       | Always include `season` (default `0` for tournaments)        |
| Player ID formatting  | Expected single UUID, needed array          | Changed DB column to `uuid[]`, updated code to handle arrays |
| Wrong item ID used    | Used UUID `id` instead of 4-digit `item_id` | Updated frontend to fetch and use 4-digit `item_id`          |

---

## Impact

These fixes ensure:

- **Consistent, valid data** across payment and registration workflows.
- **Successful payment processing** with Square.
- **Accurate change request records** supporting multiple players.
- **Future extensibility** for new registration types or payment methods.

---

## Recommendations

- Maintain **strict validation** on reference IDs and metadata before payment submission.
- Document **expected metadata structure** for all registration types.
- Use **array types** in the database where multiple entities may be involved.
- Regularly review API limits (e.g., Square's 40-char limit) to avoid integration issues.
